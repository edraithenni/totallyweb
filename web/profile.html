<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
<link href="https://fonts.cdnfonts.com/css/so-normal" rel="stylesheet">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: 'So Normal', system-ui;
    background:#000000;
    background-repeat: repeat;
    background-size: 200px 200px;
      margin: 0;
      padding: 2rem;
    }
    .profile-card {
      position: relative;
      max-width: 600px;
      margin: 0 auto;
     background-image: url("src/skeleton.jpg");
      padding: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    
      border: 2px solid #3a3a90;
      background-blend-mode: lighten;
    }
   
    .profile-card::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 20px; 
background-image: url('https://forum.melonland.net/Themes/pimp-my-classic/images/purple-flux-fade.jpg');
  background-repeat: repeat-x; 
  background-size: auto 100%;  
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}
    h1 { margin-top: 0; }
    .avatar-row {
      display:flex;
      gap:1rem;
      align-items:center;
      margin-bottom:1rem;
    }
    .avatar {
      width:96px;
      height:96px;
      border-radius:50%;
      object-fit:cover;
      background:#e9edf2;
      border:2px solid #fff;
      box-shadow:0 1px 4px rgba(0,0,0,.12);
      cursor:pointer;
    }
    .avatar:hover { transform: scale(1.05); }
    .bio { 
    white-space: pre-wrap; 
    margin-top: .5rem; 
    color: #333; 
}

    .muted { color:#282222; font-size: 25px; }
    button { cursor:pointer; padding:.45rem .75rem; border-radius:6px; border:1px solid #d0d6de; background:#fff; }
    input[type="file"] { display:none; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      max-height: 90%;
    }
    .modal-content img {
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 80vh;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .avatar-options {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
    }
    .avatar-options button {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
    }

    /* === playlists styles === */
    .playlists-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .playlist-card {
      background-color: #cd77ff ;
      border-radius: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,.1);
      overflow: hidden;
      text-align: center;
      cursor: pointer;
      transition: transform .2s;
    }
    .playlist-card:hover {
      transform: scale(1.05);
    }
    .playlist-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    .playlist-card .title {
      padding: .5rem;
      font-weight: 600;

    }
    .review-card {
      background: #2b264d;
      border: 1px solid #3a3a90;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #f1f1f1;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      transition: transform .2s;
    }

    .review-card:hover {
      transform: scale(1.02);
    }

    .review-card .movie-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #ffb3ff;
    }

    .review-card .rating {
      margin: 0.5rem 0;
    }

    .btn {
  cursor: pointer;
  border-radius: 6px;
  padding: 0.4rem 0.8rem;
  font-weight: 600;
  border: none;
  transition: all 0.2s ease;
  }

  .btn-edit {
    background-color: #ffb3ff;
    border-radius: 0;
    color: white;
  }
  .btn-edit:hover {
    background-color: #5656b0;
    border-radius: 0;
  }

  .btn-save {
    background-color: #ffb3ff;
    border-radius: 0;
    color: white;
  }
  .btn-save:hover {
    background-color: #ffb3ff;
    border-radius: 0;
  }

  .btn-cancel {
    background-color: #ffb3ff;
    border-radius: 0;
    color: white;
  }
  .btn-cancel:hover {
    background-color: #ffb3ff;
    border-radius: 0;
  }

#bioEditContainer button {
  margin-right: 0.5rem;
}



    /* === Notifications === */
    #notifBtn {
  background:#3a3a90; 
  border:none; 
  border-radius:0; 
  position:relative; 
  padding:4px;
}
#notifBtn img { display:block; }
#notifCount {
  display:none; 
  position:absolute; 
  top:-5px; 
  right:-5px; 
  background:red; 
  color:white; 
  border-radius: 0; 
  padding:0 6px; 
  font-size:0.75rem;
}
#bioTextarea {
    font-size: 20px;
}
    
  </style>
</head>
<body>
  <div class="profile-card">
    <h1 id="profileTitle">Loading...</h1>

    <!-- Notification bell -->
    <div style="position: absolute; top: 1rem; right: 1rem;">
     <button id="notifBtn">
  <img src="/static/src/mail-pink.png" alt="Notifications" style="width:35px; height:35px;">
  <span id="notifCount">0</span>
</button>

        <span id="notifCount" style="display:none; position:absolute; top:-8px; right:-8px; background:red; color:white; border-radius:50%; padding:0 6px; font-size:0.75rem;">0</span>
      </button>
      <div id="notifMenu" style="display:none; position:absolute; right:0; top:2rem; background:#24203e; color:#fff; border:1px solid #3a3a90; border-radius:6px; min-width:250px; max-height:300px; overflow-y:auto; box-shadow:0 4px 12px rgba(0,0,0,.3); z-index:100;">
        <p style="padding:0.5rem; margin:0; border-bottom:1px solid #3a3a90;">Notifications</p>
        <ul id="notifList"></ul>
      </div>
    </div>

    <div class="avatar-row">
      <img id="avatarImg" class="avatar" src="/static/src/default_pfp.png" />
      <input id="avatarInput" type="file" accept="image/*" style="display: none;">
      <div id="uploadStatus" class="muted"></div>
    </div>
    <div id="profileContent">Loading...</div>
    <hr>
    <h3>Bio</h3>
    <div id="bioBlock" class="bio muted">Loading...</div>
    <button id="editBioBtn" class="btn btn-edit">Edit</button>
    <div id="bioEditContainer" style="display:none;">
      <textarea id="bioTextarea" rows="4" style="width:100%;"></textarea>
      <button id="saveBioBtn" class="btn btn-save">Save</button>
      <button id="cancelBioBtn" class="btn btn-cancel">Cancel</button>
    </div>


    <!-- playlists section -->
    <hr>
    <h3>Playlists</h3>
    <div id="playlistsBlock" class="playlists-grid">Loading playlists...</div>

    <div id="avatarModal" class="modal">
      <div class="close-modal">&times;</div>
      <div class="modal-content">
        <img id="modalAvatar" src="" alt="Аватар">
      </div>
      <div class="avatar-options">
        <button id="changeAvatarBtn">Change pfp</button>
        <button id="deleteAvatarBtn">Delete pfp</button>
      </div>
    </div>

        <!-- reviews section -->
    <hr>
    <h3>Reviews</h3>
    <div id="reviewsBlock">Loading reviews...</div>


  <script>


    function escapeHtml(s) { if (!s) return ""; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    let currentUserId = null;
    let viewingProfileId = null;

    // Notifications state
  const notifBtn = document.getElementById("notifBtn");
  const notifMenu = document.getElementById("notifMenu");
  const notifList = document.getElementById("notifList");
  const notifCountSpan = document.getElementById("notifCount");
  let notifCount = 0;

  function addNotification(msg) {
    const li = document.createElement("li");
    li.textContent = msg;
    notifList.prepend(li);
    notifCount++;
    notifCountSpan.textContent = notifCount;
    notifCountSpan.style.display = "inline";
  }

  notifBtn.addEventListener("click", () => {
    notifMenu.style.display = notifMenu.style.display === "block" ? "none" : "block";
    if (notifMenu.style.display === "block") { notifCount = 0; notifCountSpan.style.display = "none"; }
  });

    async function loadProfile() {
      try {
        const params = new URLSearchParams(window.location.search);
        viewingProfileId = params.get("id");

        const resMe = await fetch("/api/users/me", { credentials: "include" });
        if (!resMe.ok) throw new Error("Ошибка загрузки текущего пользователя");
        const me = await resMe.json();
        currentUserId = me.id;

        if (!viewingProfileId || viewingProfileId === "null" || viewingProfileId === "undefined") {
          viewingProfileId = currentUserId;
          window.history.replaceState(null, "", `/static/profile.html?id=${currentUserId}`);
        }

        const res = await fetch(`/api/users/${viewingProfileId}`, { credentials: "include" });
        if (!res.ok) throw new Error("Ошибка HTTP " + res.status);
        const user = await res.json();

        document.getElementById("profileTitle").textContent = escapeHtml(user.name || "Your profile");
        const avatarUrl = user.avatar && user.avatar !== "" ? user.avatar : "/static/src/default_pfp.png";
        document.getElementById("avatarImg").src = avatarUrl;
        //document.getElementById("profileContent").innerHTML = `<p><b>Email:</b> ${escapeHtml(user.email || "—")}</p>`;
        const isOwnProfile = String(currentUserId) === String(viewingProfileId);
        const emailDisplay = isOwnProfile ? escapeHtml(user.email || "—") : "—";

        document.getElementById("profileContent").innerHTML = `<p><b>Email:</b> ${emailDisplay}</p>`;

        document.getElementById("bioBlock").textContent = user.description || "—";

       // const isOwnProfile = String(currentUserId) === String(viewingProfileId);
        document.getElementById("changeAvatarBtn").style.display = isOwnProfile ? "block" : "none";
        document.getElementById("deleteAvatarBtn").style.display = isOwnProfile ? "block" : "none";
        document.getElementById("avatarInput").style.display ="none";

        // === load playlists after profile ===
        await loadPlaylists(viewingProfileId);
        await loadReviews(viewingProfileId);


      } catch (err) {
        console.error("Failed to load profile:", err);
        document.getElementById("profileContent").innerHTML = "<p>Failed to load profile data</p>";
        document.getElementById("bioBlock").textContent = "—";
      }
    }

    async function loadPlaylists(userId) {
  const block = document.getElementById("playlistsBlock");
  block.innerHTML = "Loading playlists...";
  try {
    const res = await fetch(`/api/users/${userId}/playlists`, { credentials: "include" });
    if (!res.ok) throw new Error("Ошибка HTTP " + res.status);
    const data = await res.json();

    const playlists = Array.isArray(data) ? data : data.playlists || [];

    if (!playlists.length) {
      block.innerHTML = "<p class='muted'>No playlists yet</p>";
      return;
    }

    

    block.innerHTML = "";
    playlists.forEach(pl => {
  const card = document.createElement("div");
  card.className = "playlist-card";

  let iconUrl = "";
  let defaultCover  = "/static/src/default-playlist.jpg";

 if (pl.name === "watch-later") {
  iconUrl = "https://pixelsea.neocities.org/icons/puff-folder-yellow.gif";
  defaultCover = "/static/src/watch-later-playlist.jpg";
} else if (pl.name === "watched") {
  iconUrl = "https://pixelsea.neocities.org/icons/puff-folder-green.gif";
  defaultCover = "/static/src/watched-playlist.jpg";
} else if (pl.name === "liked") {
  iconUrl = "https://pixelsea.neocities.org/icons/puff-folder-red.gif";
  defaultCover = "/static/src/liked-playlist.jpg";
}


  card.innerHTML = `
    <img src="${pl.cover || defaultCover}" alt="">
    <div class="title">
      ${escapeHtml(pl.name)}
      ${iconUrl ? `<img src="${iconUrl}" style="width:20px; height:20px; margin-left:4px; vertical-align:middle;">` : ""}
    </div>
  `;

  card.addEventListener("click", () => {
    window.location.href = `/static/playlist.html?id=${pl.id}`;
  });
  block.appendChild(card);
});
  } catch (err) {
    console.error("Failed to load playlists:", err);
    block.innerHTML = "<p class='muted'>Failed to load playlists data</p>";
  }
}

  async function loadReviews(userId) {
  const block = document.getElementById("reviewsBlock");
  block.innerHTML = "Loading reviews...";
  try {
    const res = await fetch(`/api/users/${userId}/reviews`, { credentials: "include" });
    if (!res.ok) throw new Error("Ошибка HTTP " + res.status);
    const reviews = await res.json();

    if (!reviews.length) {
      block.innerHTML = "<p class='muted'>No reviews yet</p>";
      return;
    }

    block.innerHTML = "";
    reviews.forEach(rv => {
      const div = document.createElement("div");
      div.className = "review-card";
      div.style.cssText = "background:#000000; margin:0.2rem 0; padding:0.5rem; border-radius:0; color:#fff; border: 2px solid #3a3a90;";

      div.innerHTML = `
        <p><b>Movie:</b> ${escapeHtml(rv.movie_title.toString())}</p>
        <p><b>Rating:</b> ⭐ ${rv.rating}/10</p>
        <p>${escapeHtml(rv.content)}</p>
      `;

      block.appendChild(div);
    });
  } catch (err) {
    console.error("Error while loading reviews:", err);
    block.innerHTML = "<p class='muted'>Failed to load reviews</p>";
  }
}



    const avatarInput = document.getElementById("avatarInput");
    const uploadStatus = document.getElementById("uploadStatus");

    avatarInput.addEventListener('change', async (evt) => {
      const file = evt.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { uploadStatus.textContent = "Пожалуйста, выберите изображение."; return; }
      if (file.size > 5 * 1024 * 1024) { uploadStatus.textContent = "Файл слишком большой (макс 5 MB)."; return; }

      const reader = new FileReader();
      reader.onload = () => { document.getElementById("avatarImg").src = reader.result; };
      reader.readAsDataURL(file);

      uploadStatus.textContent = "Загрузка…";
      const form = new FormData();
      form.append('avatar', file);

      try {
        const resp = await fetch('/api/users/me/avatar', {
          method: 'POST',
          credentials: 'include',
          body: form
        });
        if (!resp.ok) throw new Error("Ошибка сервера " + resp.status);
        const data = await resp.json();
        document.getElementById("avatarImg").src = data.avatar || "/static/src/default_pfp.png";
        uploadStatus.textContent = "Аватар обновлён.";
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "Ошибка при загрузке аватара.";
        loadProfile();
      } finally {
        avatarInput.value = "";
        setTimeout(()=>uploadStatus.textContent="", 3000);
      }
    });

    document.getElementById("deleteAvatarBtn").addEventListener('click', async () => {
      if (!confirm("Are you sure you wanna delete avatar?")) return;
      uploadStatus.textContent = "Deleting...";
      try {
        const resp = await fetch('/api/users/me/avatar', { method: 'DELETE', credentials: 'include' });
        if (!resp.ok) throw new Error("Ошибка сервера " + resp.status);
        const data = await resp.json();
        const newAvatar = (data.avatar && data.avatar !== "") ? data.avatar : "/static/src/default_pfp.png";
        document.getElementById("avatarImg").src = newAvatar;
        closeAvatarModal();
        uploadStatus.textContent = "Аватар удалён.";
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "Ошибка при удалении аватара.";
      } finally {
        setTimeout(()=>uploadStatus.textContent="", 2500);
      }
    });

    function openAvatarModal(avatarUrl) {
      document.getElementById('modalAvatar').src = avatarUrl;
      document.getElementById('avatarModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      const isOwnProfile = String(currentUserId) === String(viewingProfileId);
      document.getElementById('deleteAvatarBtn').style.display = (isOwnProfile && avatarUrl !== "/static/src/default_pfp.png") ? "block" : "none";
      document.getElementById('changeAvatarBtn').style.display = isOwnProfile ? "block" : "none";
    }

    function closeAvatarModal() {
      document.getElementById('avatarModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    document.getElementById("avatarImg").addEventListener('click', function() {
      openAvatarModal(this.src);
    });

    document.querySelector('.close-modal').addEventListener('click', closeAvatarModal);
    document.getElementById('changeAvatarBtn').addEventListener('click', () => { closeAvatarModal(); avatarInput.click(); });
    document.getElementById('avatarModal').addEventListener('click', function(e) { if (e.target === this) closeAvatarModal(); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeAvatarModal(); });

    // === WebSocket ===
  let ws = null;
  function initWS() {
    ws = new WebSocket(`ws://localhost:8080/ws?user_id=${currentUserId}`);
    ws.onmessage = (event)=>{
      const data = event.data;
      addNotification(data);
    };
    ws.onclose = ()=>{ console.log("WS closed"); setTimeout(initWS, 2000); };
  }

   const bioBlock = document.getElementById("bioBlock");
  const editBioBtn = document.getElementById("editBioBtn");
  const bioEditContainer = document.getElementById("bioEditContainer");
  const bioTextarea = document.getElementById("bioTextarea");
  const saveBioBtn = document.getElementById("saveBioBtn");
  const cancelBioBtn = document.getElementById("cancelBioBtn");

  editBioBtn.addEventListener("click", () => {
    bioTextarea.value = bioBlock.textContent !== "—" ? bioBlock.textContent : "";
    bioBlock.style.display = "none";
    editBioBtn.style.display = "none";
    bioEditContainer.style.display = "block";
  });

  cancelBioBtn.addEventListener("click", () => {
    bioEditContainer.style.display = "none";
    bioBlock.style.display = "block";
    editBioBtn.style.display = "inline-block";
  });

  saveBioBtn.addEventListener("click", async () => {
    const newBio = bioTextarea.value.trim();
    try {
      const resp = await fetch("/api/users/me", {
        method: "PUT",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description: newBio })
      });
      if (!resp.ok) throw new Error("Update error");
      bioBlock.textContent = newBio || "—";
      bioEditContainer.style.display = "none";
      bioBlock.style.display = "block";
      editBioBtn.style.display = "inline-block";
    } catch (err) {
      console.error(err);
      alert("Failed to update bio.");
    }
  });

  loadProfile().then(()=>initWS());
  </script>
</body>
</html>
